{% extends "base.html" %}

{% block title %}{{ display_name }}{% endblock %}

{% block content %}
<a href="/home" class="btn btn-dark mb-20">‚Üê –ù–∞–∑–∞–¥</a>
<div class="card">
    <h1 class="text-center mb-4">{{ display_name }}</h1>


    {% if error %}
    <div class="alert alert-danger text-center">{{ error }}</div>
    {% else %}
    <div class="text-center mb-20">
        {% if permissions.create %}
            <a href="/add/{{ display_name }}" class="btn btn-success">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</a>
        {% endif %}

        {% if permissions.update %}
            <button class="btn btn-warning" id="editBtn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
        {% endif %}

        {% if permissions.delete %}
            <button class="btn btn-danger" id="deleteBtn">–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
        {% endif %}
    </div>

    <div class="table-container">
        <!-- üîê CSRF —Ç–æ–∫–µ–Ω -->
        <input type="hidden" id="csrfToken" value="{{ csrf_token() }}">
        {{ data|safe }}
    </div>
    {% endif %}
</div>

<script>
// –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–æ–∫
let selectedRowId = null;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏
function selectRow(row) {
    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
    document.querySelectorAll('tbody tr').forEach(r => {
        r.classList.remove('selected');
    });

    // –í—ã–¥–µ–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
    row.classList.add('selected');
    selectedRowId = row.getAttribute('data-row-id');

    console.log('–í—ã–±—Ä–∞–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Å ID:', selectedRowId);
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ —Ç–∞–±–ª–∏—Ü–µ
document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('.data-table');
    if (!table) return;

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—Ç—Ä–æ–∫
    table.querySelectorAll('tbody tr').forEach(row => {
        // –î–µ–ª–∞–µ–º —Å—Ç—Ä–æ–∫—É –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π
        row.style.cursor = 'pointer';

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
        row.addEventListener('click', function(e) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —Å—Å—ã–ª–∫–∞–º –∏ –∫–Ω–æ–ø–∫–∞–º
            if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
                return;
            }
            if (e.target.closest('a') || e.target.closest('button')) {
                return;
            }

            // –í—ã–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É
            selectRow(this);
        });

        // –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–≤–µ–¥–µ–Ω–∏—è
        row.addEventListener('mouseenter', function() {
            if (!this.classList.contains('selected')) {
                this.style.backgroundColor = '#f5f5f5';
            }
        });

        row.addEventListener('mouseleave', function() {
            if (!this.classList.contains('selected')) {
                this.style.backgroundColor = '';
            }
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const editBtn = document.getElementById('editBtn');
    if (editBtn) {
        editBtn.addEventListener('click', function() {
            if (!selectedRowId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–æ–∫—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }

            const tableName = "{{ display_name }}";
            const editUrl = `/edit/${tableName}/${selectedRowId}`;
            window.location.href = editUrl;
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
    const deleteBtn = document.getElementById('deleteBtn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            if (!selectedRowId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–æ–∫—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }

            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å —Å ID ${selectedRowId}?`)) {
                return;
            }

            const tableName = "{{ display_name }}";
            const deleteUrl = `/delete/${tableName}/${selectedRowId}`;
            const csrfToken = document.getElementById('csrfToken').value;

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å —Å CSRF —Ç–æ–∫–µ–Ω–æ–º
            fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    '_csrf_token': csrfToken
                })
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏');
            });
        });
    }
});
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ —Ç–∞–±–ª–∏—Ü–µ
document.addEventListener('DOMContentLoaded', function() {
    const table = document.querySelector('.data-table');
    if (!table) return;

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º data-row-id –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏
    table.querySelectorAll('tbody tr').forEach(row => {
        // –ù–∞—Ö–æ–¥–∏–º —è—á–µ–π–∫—É —Å ID (–ø–µ—Ä–≤–∞—è —è—á–µ–π–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ)
        const idCell = row.cells[0]; // –ü–µ—Ä–≤–∞—è —è—á–µ–π–∫–∞ - —ç—Ç–æ ID
        if (idCell) {
            const idText = idCell.textContent.trim();
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ HTML —Ç–µ–≥–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, <span>)
            const cleanId = idText.replace(/<[^>]*>/g, '').trim();
            row.setAttribute('data-row-id', cleanId);
        }
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—Ç—Ä–æ–∫
    table.querySelectorAll('tbody tr').forEach(row => {
        // –î–µ–ª–∞–µ–º —Å—Ç—Ä–æ–∫—É –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π
        row.style.cursor = 'pointer';

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
        row.addEventListener('click', function(e) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —Å—Å—ã–ª–∫–∞–º –∏ –∫–Ω–æ–ø–∫–∞–º
            if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
                return;
            }
            if (e.target.closest('a') || e.target.closest('button')) {
                return;
            }

            // –í—ã–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É
            selectRow(this);
        });

        // –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–≤–µ–¥–µ–Ω–∏—è
        row.addEventListener('mouseenter', function() {
            if (!this.classList.contains('selected')) {
                this.style.backgroundColor = '#f5f5f5';
            }
        });

        row.addEventListener('mouseleave', function() {
            if (!this.classList.contains('selected')) {
                this.style.backgroundColor = '';
            }
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const editBtn = document.getElementById('editBtn');
    if (editBtn) {
        editBtn.addEventListener('click', function() {
            if (!selectedRowId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–æ–∫—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }

            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ ID - —á–∏—Å–ª–æ
            const idNum = parseInt(selectedRowId);
            if (isNaN(idNum)) {
                alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –∑–∞–ø–∏—Å–∏');
                return;
            }

            const tableName = "{{ display_name }}";
            const editUrl = `/edit/${tableName}/${idNum}`;
            window.location.href = editUrl;
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
    const deleteBtn = document.getElementById('deleteBtn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', function() {
            if (!selectedRowId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–æ–∫—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }

            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ ID - —á–∏—Å–ª–æ
            const idNum = parseInt(selectedRowId);
            if (isNaN(idNum)) {
                alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –∑–∞–ø–∏—Å–∏');
                return;
            }

            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å —Å ID ${idNum}?`)) {
                return;
            }

            const tableName = "{{ display_name }}";
            const deleteUrl = `/delete/${tableName}/${idNum}`;
            const csrfToken = document.getElementById('csrfToken').value;

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å —Å CSRF —Ç–æ–∫–µ–Ω–æ–º
            fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    '_csrf_token': csrfToken
                })
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏');
            });
        });
    }
});
</script>

<style>
.badge {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: bold;
    display: inline-block;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ */
tr.selected {
    background-color: #e8f4fd !important;
    box-shadow: inset 3px 0 0 #2196f3;
}

.table-container {
    overflow-x: auto;
}

/* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å—Ç—Ä–æ–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã */
.data-table tbody tr {
    cursor: pointer;
    transition: background-color 0.2s;
}

.data-table tbody tr:hover {
    background-color: #f5f5f5;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
.btn-success {
    background-color: #28a745;
    color: white;
    border: 1px solid #28a745;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}

.btn-warning {
    background-color: #ffc107;
    color: #212529;
    border: 1px solid #ffc107;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-danger {
    background-color: #dc3545;
    color: white;
    border: 1px solid #dc3545;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-dark {
    background-color: #343a40;
    color: white;
    border: 1px solid #343a40;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.data-table th {
    background-color: #f2f2f2;
    font-weight: bold;
}

.alert-danger {
    background-color: #f8d7da;
    color: #721c24;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.text-center {
    text-align: center;
}

.mb-20 {
    margin-bottom: 20px;
}

.mb-4 {
    margin-bottom: 1.5rem;
}

.card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>
{% endblock %}